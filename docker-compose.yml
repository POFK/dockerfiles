version: '3.8'

services:
  vim:
    # docker-compose exec --user dev vim bash
    # docker exec --user dev -it workflow-vim bash
    image: txmao/vimtx:latest
    container_name: workflow-vim
    restart: always
    stdin_open: true
    tty: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/.X11-unix:/tmp/.X11-unix
      - $HOME/workspace:/home/workspace
      - chrome:/chrome-volume:ro
      - dotfiles-volume:/dotfiles-volume:ro
    environment:
      - DISPLAY=$DISPLAY
    network_mode: host
    ipc: host
    
  chrome:
    # docker-compose --compatibility start chrome
    # docker --compatibility start workflow-chrome
#   image: txmao/chrome:latest
    build: 
      context: ./chrome
      dockerfile: Dockerfile
    container_name: workflow-chrome
    privileged: true
    entrypoint: ["google-chrome"]
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - $HOME/Downloads:/home/chrome/Downloads
      - /dev/shm:/dev/shm
      - chrome:/home/chrome/.config
    environment:
      - DISPLAY=$DISPLAY
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
      - /dev/dri:/dev/dri
    deploy:
      resources:
        limits:
          memory: 3000M
    depends_on:
      - chrome-backup

  monitor:
    # docker start workflow-bashtop
    # docker-compose --compatibility exec monitor bashtop
    build:
      context: ./bashtop
      dockerfile: Dockerfile
    container_name: workflow-monitor
    stdin_open: true
    entrypoint: ["/usr/bin/bash"]
    privileged: true
    network_mode: host
    ipc: host
    pid: host


  wpd:
    # docker-compose --compatibility exec wpd bashtop
    build:
      context: ./WebPlotDigitizer
      dockerfile: Dockerfile
    container_name: workflow-wpd
    ports:
      - "4500:8080"


  proxy:
    image: dreamacro/clash:0.20.0 # latest image not work... @2020-06-29
    container_name: workflow-proxy
    restart: always
    volumes:
      - dotfiles-volume:/root
    ports:
      - "7890:7890"
      - "1080:7891"
      - "9090:9090"

  proxy-ui:
    image: haishanh/yacd:0.1.23
    container_name: workflow-proxy-ui
    restart: always
    ports:
      - "9091:80"
    depends_on:
      - proxy
 

  dotdrop:
    # docker-compose --compatibility start dotdrop
    # docker-compose --compatibility run dotdrop install -p docker
    build:
      context: ./dotdrop
      dockerfile: Dockerfile
    container_name: workflow-dotdrop
    volumes:
      - $HOME/git/dotfiles:/dotfiles
      - dotfiles-volume:/home/user

  chrome-backup:
    # docker-compose exec chrome-backup ./backup.sh
    # docker run --rm -v chrome:/dbdata -v $HOME/backup/chrome:/backup ubuntu bash -c 'cd /dbdata &&  tar xzvf `ls /backup/backup*.tar.gz  -t | head -1` --strip 1'
    image: futurice/docker-volume-backup:2.1.0
    container_name: workflow-chrome-backup
    restart: always
    environment:
      BACKUP_CRON_EXPRESSION: "0 4 * * *"
      TZ: "Asia/Shanghai"
    volumes:
      - chrome:/backup/chrome:ro    # Mount the Grafana data volume (as read-only)
      - $HOME/backup/chrome:/archive        # Mount a local folder as the backup archive
    depends_on:
      - backup-rotate

  backup-rotate:
    build:
      context: ./python-rotation-backups
      dockerfile: Dockerfile
    container_name: workflow-rotate
    stdin_open: true
    tty: true
    volumes:
      - $HOME/backup/chrome:/archive        # Mount a local folder as the backup archive
      - ./python-rotation-backups/rotate-backups.ini:/root/.rotate-backups.ini:ro
      - ./python-rotation-backups/cronjobs:/etc/crontabs/root:ro

volumes:
  chrome:
    name: chrome
  dotfiles-volume:
    name: dotfiles
